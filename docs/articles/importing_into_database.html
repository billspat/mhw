<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with the MHW-CI database • mhwci</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with the MHW-CI database">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mhwci</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/importing_into_database.html">Working with the MHW-CI database</a></li>
    <li><a class="dropdown-item" href="../articles/using_mhw_database.html">Using the MHW-CI database to plot</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with the MHW-CI database</h1>
            
      

      <div class="d-none name"><code>importing_into_database.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://billspat.github.io/mhw/" class="external-link">mhwci</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: magrittr</span></span></code></pre></div>
<div class="section level2">
<h2 id="about-the-database">About the database<a class="anchor" aria-label="anchor" href="#about-the-database"></a>
</h2>
<p>This project stores data into a single, local, SQL database which
uses the <a href="https://duckdb.org" class="external-link">duckdb</a> platform. This platform
is easy to install (<code>install.packages('duckdb')</code>) can work
with a local file (no server required). This project imports tables
created for each scenario, and the tables include all the ensemble
members with a column “ensemble” indicating which one.</p>
<p>It imports from CSV files created by Dr. Lala Kounta using
Matlab.</p>
<p>see vignette(“using_mhw_database”) for reading, summarizing and
plotting data.</p>
</div>
<div class="section level2">
<h2 id="export-to-csv">Export to CSV<a class="anchor" aria-label="anchor" href="#export-to-csv"></a>
</h2>
<p>Currently, scenario/ensemble files are in Matlab data format (HDF5)
and we’ve found that it’s best to use Matlab to export those.</p>
<p>Essentially the files need to be opened in matlab , selecting the
data element to save, and then using <code>writetable()</code></p>
<p>given a matlab file path in the variable `f’ with data element
(matrix) MHW with the MHW metrics in it, just do</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode matlab"><code class="sourceCode matlab"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">% load MHW matrix</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="va">mhwdata</span> <span class="op">=</span> <span class="va">load</span>(<span class="va">f</span><span class="op">,</span><span class="ss">'MHW'</span>)<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">% construct a new file name for the CSV export </span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="va">mhwfile</span> <span class="op">=</span> <span class="va">strcat</span>(<span class="va">f</span><span class="op">,</span> <span class="ss">'.mhw.csv'</span>)<span class="op">;</span> </span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">% export to CSV</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="va">writetable</span>(<span class="va">mhwdata</span>.<span class="va">MHW</span><span class="op">,</span> <span class="va">mhwfile</span>)<span class="op">;</span></span></code></pre></div>
<p>See the file <code>matlab/mhw_export_text.m</code> for a short script
that will read all files in a directory (ensemble outputs) and use
parallel pool to write these to a CSV files.</p>
</div>
<div class="section level2">
<h2 id="creating-sql-code-for-import">Creating SQL code for import<a class="anchor" aria-label="anchor" href="#creating-sql-code-for-import"></a>
</h2>
<p>duckdb makes it very easy to read from various formats using the
<code>Select * from &lt;filepath&gt;</code> syntax To import multiple
CSVs into a table, I use the strategy that uses the ‘union’ to combine
multiple select statements. See the file <a href="db/build_mhw_db.sql"><code>db/build_mhw_db.sql</code></a> for an
example of how to do this. These SQL statements assume that the CSV
files are created and you have a file path to them.</p>
<p>Example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> arise10_metrics <span class="kw">as</span> </span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span>, <span class="st">'001'</span> <span class="kw">AS</span> ensemble, <span class="st">'ARISE-1.0'</span> <span class="kw">AS</span> scenario <span class="kw">FROM</span> <span class="st">'ARISE-1.0/MHW_metrics_Model_001.mat.mhw.csv'</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="kw">UNION</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="op">*</span>, <span class="st">'002'</span> <span class="kw">AS</span> ensemble, <span class="st">'ARISE-1.0'</span> <span class="kw">AS</span> scenario <span class="kw">FROM</span> <span class="st">'ARISE-1.0/MHW_metrics_Model_002.mat.mhw.csv'</span>;</span></code></pre></div>
<p>the actual example import ensembles ‘001’ to ‘010’.</p>
<p>When running a select statement, you can create new columns with
constant values by just using the syntax <constant> as <column name>
which creates a new column with the same value in every row. This is a
useful for creating a colum with <code>ensemble</code> number since
there is no such column in the source data but we want to know that.
Since the scenarios are all in different tables it may not be essential
that we also create a <code>scenario</code> column but it’s good to be
pro-active since we may want to combine metrics across scenarios for
comparison in the database if it takes too long or too much memory to do
it in R.</column></constant></p>
<p>You can create a new table by copying this syntax, changing the table
name and the file paths. In SQL there is no concept of loops or other
conditionals, while you could generate this code using a programming
language like R it’s just easier to copy/paste</p>
</div>
<div class="section level2">
<h2 id="latlong">lat/long<a class="anchor" aria-label="anchor" href="#latlong"></a>
</h2>
<p>The originl matlab matrices use an index number for x and y and those
must be converted to lat/lon. See the <code>build_mhw_db.sql</code> for
how a table with the lat/lon and the indexes are created from exports,
and how they can be used to add new columns into a table you’ve created
using the syntax above.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">alter</span> <span class="kw">table</span> arise10_metrics <span class="kw">add</span> <span class="kw">column</span> lat <span class="dt">DOUBLE</span>;</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">update</span> arise10_metrics <span class="kw">set</span> lat <span class="op">=</span> lat_index.lat <span class="kw">from</span> lat_index <span class="kw">where</span> arise10_metrics.yloc <span class="op">=</span> lat_index.yloc ;</span></code></pre></div>
<p>the <code>update</code> command uses the <code>where</code> clause to
link the <code>yloc</code> value in the original table with a
<code>yloc</code> value in the <code>lat_index</code> table and then
links that to a latititude value <code>lat</code></p>
<p>repeat for <code>lon</code></p>
</div>
<div class="section level2">
<h2 id="index">Index<a class="anchor" aria-label="anchor" href="#index"></a>
</h2>
<p>Creating indexes is optional and only necessary if you find using SQL
on these tables takes a long time.</p>
</div>
<div class="section level2">
<h2 id="running-sql-code">running SQL code<a class="anchor" aria-label="anchor" href="#running-sql-code"></a>
</h2>
<p>Once you create a SQL file or a list of SQL commands, you need to run
them against a database. For duckdb, a database is just another file
(with any name) so you have to tell duckdb which db file to open.</p>
<p>You can run them against any of the database versions you have, but
that database needs to already have the <code>lat_index</code> and
<code>lon_index</code> tables to convert x/y indexes to lat and lon.</p>
<p>There are several methods to accomplish this but I use the command
line. For all of these, the folder where you run the script/sql commands
must be correct for the path to CSV file for the SQL statements</p>
<div class="section level4">
<h4 id="using-the-duckdb-command-line-interface">using the duckdb Command line interface<a class="anchor" aria-label="anchor" href="#using-the-duckdb-command-line-interface"></a>
</h4>
<ol style="list-style-type: decimal">
<li>install duckdb by downloading the zip file from <a href="https://duckdb.org" class="external-link uri">https://duckdb.org</a> (for your
laptop, for for linux on the HPC) into your home directory and
unzipping</li>
<li>know the path of where the duckdb file is located (or optionally add
that location to your $PATH)</li>
<li>know the path to your database. For me that path is
<code>db/mhw_ci.db</code> but it could be anywhere</li>
<li>change to the folder where the CSV files are</li>
<li>open the database with the duckdb command:
<code>path/to/duckdb path/to/mhw_ci.db</code><br>
</li>
<li>inside the duckdb command line interface, type the sql command (or
copy/paste) to run: <code>sql * from x_lat</code> for example</li>
</ol>
</div>
<div class="section level4">
<h4 id="running-a-sql-script-using-the-duckdb-program">running a sql script using the duckdb program<a class="anchor" aria-label="anchor" href="#running-a-sql-script-using-the-duckdb-program"></a>
</h4>
<p>alternatives to steps 5 &amp; 6 above is just step 5, if you are in
the folder where the CSV files are</p>
<ol start="5" style="list-style-type: decimal">
<li>run the sql code from the file on the database:</li>
</ol>
<p><code>path/to/duckdb path/to/database.db &lt; path/to/my.sql</code></p>
<p>For me that command is</p>
<p><code>duckdb db/mhwci.db db/build_mhw_db.sql</code></p>
</div>
<div class="section level4">
<h4 id="alternative-using-rstudio">Alternative using Rstudio<a class="anchor" aria-label="anchor" href="#alternative-using-rstudio"></a>
</h4>
<p>If you place a special comment at the top of your SQL file, you can
run the script directly in Rstudio. It requires the <code>duckdb</code>
package to be installed, and the CSV file path in the SQL to be relative
to your R project folder.</p>
<p>See the file <code>db/example.sql</code> which has the comment</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">-- !preview conn=DBI::dbConnect(duckdb::duckdb(), dbdir = 'db/mhwci_v3.db')</span></span></code></pre></div>
<p>if the SQL commands return a table, it will be previewed. If the
commands create tables (those are called “data definition language” or
DDL commands) then they should still run in Rstudio provide the path to
the CSV files in the SQL commands is correct.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pat Bills, Lala Kounta, Phoebe Zarnetske.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
